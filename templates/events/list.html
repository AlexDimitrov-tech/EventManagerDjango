{% extends 'base.html' %}
{% load event_extras %}

{% block title %}Events ‚Äì LocalVibe{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>All Events</h2>
    <a href="{% url 'event_create' %}" class="btn btn-primary">+ Add Event</a>
  </div>

  <form method="get" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" value="{{ search_query }}" placeholder="Search events..." class="form-control">
    </div>
    <div class="col-md-3">
      <select name="venue" class="form-select">
        <option value="">All venues</option>
        {% for v in all_venues %}
        <option value="{{ v.pk }}" {% if selected_venue_id == v.pk|stringformat:"s" %}selected{% endif %}>{{ v.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">All categories</option>
        {% for c in all_categories %}
        <option value="{{ c.pk }}" {% if selected_category_id == c.pk|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select name="sort" class="form-select">
        <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title A-Z</option>
        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price ‚Üë</option>
        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price ‚Üì</option>
      </select>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-secondary btn-sm">Apply Filters</button>
      <a href="{% url 'event_list' %}" class="btn btn-outline-secondary btn-sm ms-1">Clear</a>
    </div>
  </form>

  {% if events %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for event in events %}
    <div class="col">
      <div class="card h-100">
        <div class="card-body">
          <div class="mb-2">
            <span class="badge" style="background-color: {% if event.status == 'published' %}#198754{% elif event.status == 'cancelled' %}#dc3545{% else %}#6c757d{% endif %};">
              {{ event.status }}
            </span>
            {% if event.is_free %}
            <span class="badge bg-info ms-1">Free</span>
            {% endif %}
          </div>
          <h5 class="card-title">
            <a href="{{ event.get_absolute_url }}" style="text-decoration:none; color: inherit;">{{ event.title }}</a>
          </h5>
          {% if event.description %}
          <p class="card-text text-muted" style="font-size: 0.88rem;">{{ event.description|short_desc:90 }}</p>
          {% endif %}
          {% if event.categories.all %}
          <div class="mb-2">
            {% for cat in event.categories.all %}
            <span class="badge bg-secondary" style="font-size:0.75rem;">{{ cat.name }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="card-footer" style="font-size: 0.83rem;">
          <div class="d-flex justify-content-between">
            <span>üìÖ {{ event.date }}{% if event.time %} {{ event.time }}{% endif %}</span>
            <span class="fw-bold">{{ event.price|format_price }}</span>
          </div>
          {% if event.venue %}
          <div class="text-muted mt-1">üìç {{ event.venue.name }}</div>
          {% endif %}
          <div class="mt-2 d-flex gap-1">
            <a href="{{ event.get_absolute_url }}" class="btn btn-sm btn-outline-primary">View</a>
            <a href="{% url 'event_edit' event.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
            <a href="{% url 'event_delete' event.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-warning mt-3">
    No events found.
    {% if search_query %}
    Try a different search term.
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
